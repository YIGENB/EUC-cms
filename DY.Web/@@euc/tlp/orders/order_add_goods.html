#if (!$isajax) 
#parse("pageheader.html")
<script src="/include/js/jquery/jquery-migrate-1.2.1.js" type="text/javascript"></script>
<script type="text/javascript" src="/include/js/jquery/jquery.form.js"></script>
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>
            选择商品</h2>
        <ol class="breadcrumb">
            <li><a href="main.aspx">主页</a> </li>
            <li><strong>添加订单</strong> </li>
        </ol>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight white-bg">
    <div class="row">
        <div class="col-lg-12">
        <form name="theForm" action="order.aspx?act=add&step=edit_goods&order_id=$id" method="post">
        <div class="list-div" id="listDiv">
            #end
            <table cellpadding="3" cellspacing="1" class="table">
                <tr>
                    <th scope="col">
                        商品名称
                    </th>
                    <th scope="col">
                        货号
                    </th>
                    <th scope="col">
                        价格
                    </th>
                    <th scope="col">
                        数量
                    </th>
                    <th scope="col">
                        小计
                    </th>
                    <th scope="col">
                        操作
                    </th>
                </tr>
                #foreach($row in $ordergoodslist)
                <tr>
                    <td>
                        <a href="#" onclick="getGoodsInfo(${row.goods_id});">${row.goods_name}</a>
                    </td>
                    <td>
                        ${row.goods_sn}<input name="rec_id" type="hidden" value="${row.rec_id}" />
                    </td>
                    <td align="center">
                        <input type="hidden" name="old_goods_price" value="${row.goods_price}" />
                        ${row.goods_price}/${row.extension_code}
                    </td>
                    <td align="center">
                        <input type="hidden" name="old_goods_number" value="${row.goods_number}" />
                        <input name="goods_number" type="text" style="text-align: right" value="${row.goods_number}"
                            size="6" />/${row.extension_code}
                    </td>
                    <td align="right">
                        #set($xj = ${row.goods_price} * ${row.goods_number}) $xj
                    </td>
                    <td align="center">
                        <a href="javascript:delOrderGoodsById(${row.rec_id});">删除</a>
                    </td>
                </tr>
                #end
                <tr>
                    <td colspan="3">
                        <span class="require-field"></span>
                    </td>
                    <td align="right">
                        <strong>合计：</strong>
                    </td>
                    <td align="right">
                        ￥$order_price元
                    </td>
                    <td align="center">
                       <!-- <input name="edit_goods" type="submit" class="btn btn-w-m btn-white" value="更新商品" />-->
                        <input name="goods_count" type="hidden" value="$ordergoodslist.Count" />
                    </td>
                </tr>
            </table>
            #if (!$isajax)
            </div>
            </form>
        </div>
    </div>
<div class="row">
    <div class="ibox-content">
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <form name="goodsForm" action="order.aspx?act=add&is_ajax=1&step=add_goods&order_id=${order_id}" class="form-horizontal" method="post" onsubmit="return addToOrder(this)">
        <div class="form-group">
            <label class="col-sm-2 control-label">
                按商品编号或商品货号搜索：</label>
            <div class="col-sm-9">
                <div class="col-md-3">
                    <input type="text" class="form-control" name="keyword" value="" />
                    <input type="hidden" name="cat_id" value="0" />
                </div>
                <div class="col-md-3">
                    <select name="cat_id" class="form-control m-b">
                        <option value="0" name="">请选择...</option>
                        #GoodsCatSelectUI($GoodsCatId)
                    </select>
                </div>
                <div class="col-md-1">
                <input type="button" name="search" value=" 搜索 " class="btn btn-primary" onclick="searchGoods();" />
                </div>
                <div class="col-md-2">
                    <select name="goodslist" onchange="getGoodsInfo(this.value)" class="form-control m-b">
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
        <div class="list-div">
            <table cellpadding="3" cellspacing="1" class="table">
                <tr>
                    <th width="100">
                        商品名称
                    </th>
                    <td id="goods_name">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        货号
                    </th>
                    <td id="goods_sn">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        分类
                    </th>
                    <td id="goods_cat">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        品牌
                    </th>
                    <td id="goods_brand">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        价格
                    </th>
                    <td id="add_price">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        属性<input type="hidden" name="spec_count" value="0" />
                    </th>
                    <td id="goods_attr">
                        &nbsp;
                    </td>
                </tr>
                <tr>
                    <th>
                        数量
                    </th>
                    <td>
                        <input name="add_number" type="text" value="1" size="10" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2" align="center">
                        <input name="add_goods" type="submit" class="btn btn-primary" value="加入订单" />
                    </td>
                </tr>
            </table>
        </div>
        </div>
        </form>
    </div>
    <form action="" method="post" onsubmit="return checkGoods()">
    <p align="center">
        <input name="next" type="submit" class="btn btn-w-m btn-white" value="下一步"  />
        <input type="button" value="取消" class="btn btn-w-m btn-white" onclick="location.href='order.aspx?act=add&step=delete&order_id=$order_id'" />
    </p>
    </form>
</div>
<script language="JavaScript">
    function checkGoods() {
        var eles = document.forms['theForm'].elements;

        if (eles['goods_count'].value <= 0) {
            alert_toastr("请添加订单商品");
            return false;
        }
        else {
            location.href = 'order.aspx?act=add&step=consignee&order_id=$order_id';
        }
        return false;
    }

    /**
    * 按商品编号或商品名称或商品货号搜索商品
    */
    function searchGoods() {
        var eles = document.forms['goodsForm'].elements;

        /* 填充列表 */
        var keyword = Utils.trim(eles['keyword'].value);

        //类别
        var cat_id = eles['cat_id'].value;

        Ajax.call('goods.aspx?act=search_goods&q=' + keyword + '&cat_id=' + cat_id, '', searchGoodsResponse, 'GET', 'JSON');
    }

    function searchGoodsResponse(result) {
        if (result.message.length > 0) {
            alert(result.message);
        }

        if (result.error == 0) {
            var eles = document.forms['goodsForm'].elements;

            /* 清除列表 */
            var selLen = eles['goodslist'].options.length;
            for (var i = selLen - 1; i >= 0; i--) {
                eles['goodslist'].options[i] = null;
            }

            var arr = result.content;
            var goodsCnt = arr.length;
            if (goodsCnt > 0) {
                for (var i = 0; i < goodsCnt; i++) {
                    var opt = document.createElement('OPTION');
                    opt.value = arr[i].goods_id;
                    opt.text = arr[i].name;
                    eles['goodslist'].options.add(opt);
                }
                getGoodsInfo(arr[0].goods_id);
            }
            else {
                getGoodsInfo(0);
            }
        }
    }

    /**
    * 取得某商品信息
    * @param int goodsId 商品id
    */
    function getGoodsInfo(goodsId) {
        if (goodsId > 0) {
            Ajax.call('goods.aspx?act=get_goods_info', 'goods_id=' + goodsId, getGoodsInfoResponse, 'get', 'json');
        }
        else {
            document.getElementById('goods_name').innerHTML = '';
            document.getElementById('goods_sn').innerHTML = '';
            document.getElementById('goods_cat').innerHTML = '';
            document.getElementById('goods_brand').innerHTML = '';
            document.getElementById('add_price').innerHTML = '';
            document.getElementById('goods_attr').innerHTML = '';
        }
    }
    function getGoodsInfoResponse(result) {
        var eles = document.forms['goodsForm'].elements;

        // 显示商品名称、货号、分类、品牌
        document.getElementById('goods_name').innerHTML = result.goods_name;
        document.getElementById('goods_sn').innerHTML = result.goods_sn;
        document.getElementById('goods_cat').innerHTML = result.cat_name;
        document.getElementById('goods_brand').innerHTML = result.brand_name;

        // 显示价格：包括市场价、本店价（促销价）、会员价
        var priceHtml = '' +
      '<input type="radio" name="add_price" value="' + result.shop_price + '" checked />$config.PriceName2 [' + result.shop_price + '/' + result.weight_unit + ']<br />';
        for (var i = 0; i < result.user_price.length; i++) {
            priceHtml += '<input type="radio" name="add_price" value="' + result.user_price[i].user_price + '" />' + result.user_price[i].rank_name + ' [' + result.user_price[i].user_price + '/' + result.weight_unit + ']<br />';
        }
        priceHtml += '<input type="radio" name="add_price" value="' + result.market_price + '" />$config.PriceName1 [' + result.market_price + '/' + result.weight_unit + ']<br />';
        if (result.is_promote == "true") {
            priceHtml += '<input type="radio" name="add_price" value="' + result.promote_price + '" />促销价 [' + result.promote_price + '/' + result.weight_unit + ']<br />';
        }
        priceHtml += '<input type="radio" name="add_price" value="user_input" />手动输入<input type="text" name="input_price" size="4" value="" />元/' + result.weight_unit + '<br />';
        document.getElementById('add_price').innerHTML = priceHtml;

        // 显示属性
        var specCnt = 0; // 规格的数量
        var attrHtml = '';
        var attrCnt = result.attr_list.length;
        for (i = 0; i < attrCnt; i++) {
            var valueCnt = result.attr_list[i].length;
            // 规格
            if (valueCnt > 1) {
                attrHtml += result.attr_list[i][0].attr_name + ': ';
                for (var j = 0; j < valueCnt; j++) {
                    attrHtml += '<input type="radio" name="spec_' + specCnt + '" value="' + result.attr_list[i][j].goods_attr_id + '"';
                    if (j == 0) {
                        attrHtml += ' checked';
                    }
                    attrHtml += ' />' + result.attr_list[i][j].attr_value;
                    if (result.attr_list[i][j].attr_price > 0) {
                        attrHtml += ' [+' + result.attr_list[i][j].attr_price + ']';
                    }
                    else if (result.attr_list[i][j].attr_price < 0) {
                        attrHtml += ' [-' + Math.abs(result.attr_list[i][j].attr_price) + ']';
                    }
                }
                attrHtml += '<br />';
                specCnt++;
            }
            // 属性
            else {
                //attrHtml += result.attr_list[i][0].attr_name + ': ' + result.attr_list[i][0].attr_value + '<br />';
                attrHtml += result.attr_list[i].attr_name + ': ' + result.attr_list[i].attr_value + '<br />';
            }
        }
        eles['spec_count'].value = specCnt;
        document.getElementById('goods_attr').innerHTML = attrHtml;
    }

    /**
    * 把商品加入订单
    */
    function addToOrder(form) {
        var eles = document.forms['goodsForm'].elements;

        // 检查是否选择了商品
        if (eles['goodslist'].options.length <= 0) {
            alert_toastr("请先搜索商品");
            return false;
        }
        else {
            $(form).ajaxSubmit({
                dataType: 'json',
                success: function (data) {
                    if (data.error > 0) {
                        alert(data.message);
                    }
                    else {
                                                $('#listDiv').html(data.content);
//                        alert_toastr(data.content);
//                        return false;
                    }
                }
            });
        }

        return false;
    }

    /**
    * 删除订单商品
    * @param int addressId 收货地址id
    */
    function delOrderGoodsById(id) {
        Ajax.call('order.aspx?act=add', 'is_ajax=1&step=delete_order_goods&order_id=$order_id&rec_id=' + id, function (data) {
            if (data.error > 0) {
                alert(data.message);
            }
            else {
                $('#listDiv').html(data.content);
            }
        }, 'get', 'json');
    }
</script>
#parse("pagefooter.html") 
#end